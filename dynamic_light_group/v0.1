light:
  - platform: template
    lights:
      all_lights_on:
        friendly_name: Dynamic Template Light Group
        value_template: >
          {% set lights = states.light
            | rejectattr('entity_id', 'eq', this.entity_id)
            | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
            | rejectattr('entity_id', 'in', integration_entities('group'))
            | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
            | rejectattr('entity_id', 'in', integration_entities('demo'))
            | rejectattr('entity_id', 'in', integration_entities('Demo'))
            | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
            | selectattr('state' , 'eq' , 'on') 
            | map (attribute='entity_id')
            | list
          %}
          {{ lights | count > 0 }}
        level_template: >
          {% set lights = states.light
            | rejectattr('entity_id', 'eq', this.entity_id)
            | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
            | rejectattr('entity_id', 'in', integration_entities('group'))
            | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
            | rejectattr('entity_id', 'in', integration_entities('demo'))
            | rejectattr('entity_id', 'in', integration_entities('Demo'))
            | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
            | selectattr('state' , 'eq' , 'on')
            | map(attribute='entity_id')
            | list
          %}
          {% set bright = lights | map('state_attr', 'brightness') | map('default', 255, true) | list %}
          {{ bright | average | round(0) | int if bright else 0 }}
        temperature_template: >
          {% set lights = states.light
            | rejectattr('entity_id', 'eq', this.entity_id)
            | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
            | rejectattr('entity_id', 'in', integration_entities('group'))
            | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
            | rejectattr('entity_id', 'in', integration_entities('demo'))
            | rejectattr('entity_id', 'in', integration_entities('Demo'))
            | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
            | selectattr('state' , 'eq' , 'on')
            | map(attribute='entity_id')
            | list
          %}
          {% set temperature = lights | map('state_attr', 'color_temp') | map('default', 255, true) | list %}
          {{ temperature | average | round(0) | int if temperature else 0 }}
        supports_transition_template: "{{ true }}"
  
        turn_on:
          - variables:
              lights: > 
                {{ states.light
                    | rejectattr('entity_id', 'eq', this.entity_id)
                    | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
                    | rejectattr('entity_id', 'in', integration_entities('group'))
                    | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
                    | rejectattr('entity_id', 'in', integration_entities('demo'))
                    | rejectattr('entity_id', 'in', integration_entities('Demo'))
                    | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
                    | map(attribute='entity_id')
                    | list
                }}
          - service: light.turn_on
            data:
              entity_id: "{{ lights }}"
        turn_off:
          - variables:
              lights: > 
                {{ states.light
                    | rejectattr('entity_id', 'eq', this.entity_id)
                    | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
                    | rejectattr('entity_id', 'in', integration_entities('group'))
                    | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
                    | rejectattr('entity_id', 'in', integration_entities('demo'))
                    | rejectattr('entity_id', 'in', integration_entities('Demo'))
                    | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
                    | selectattr('state' , 'eq' , 'on')
                    | map(attribute='entity_id')
                    | list
                }}
          - service: light.turn_off
            data:
              entity_id: "{{ lights }}"
  
        set_level:
          - variables:
              lights: > 
                {{ states.light
                    | rejectattr('entity_id', 'eq', this.entity_id)
                    | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
                    | rejectattr('entity_id', 'in', integration_entities('group'))
                    | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
                    | rejectattr('entity_id', 'in', integration_entities('demo'))
                    | rejectattr('entity_id', 'in', integration_entities('Demo'))
                    | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
                    | selectattr('state' , 'eq' , 'on')
                    | selectattr('attributes.brightness', 'defined')
                    | map(attribute='entity_id')
                    | list
                }}
          - if: "{{ lights | count > 0 }}"
            then:
              - service: light.turn_on
                data:
                  entity_id: "{{ lights }}"
                  brightness: "{{ brightness }}"
  
        set_temperature:
          - variables:
              lights: > 
                {{ states.light
                    | rejectattr('entity_id', 'eq', this.entity_id)
                    | rejectattr('entity_id', 'eq', 'light.dynamic_lights')
                    | rejectattr('entity_id', 'in', integration_entities('group'))
                    | rejectattr('entity_id', 'in', integration_entities('fullykiosk'))
                    | rejectattr('entity_id', 'in', integration_entities('demo'))
                    | rejectattr('entity_id', 'in', integration_entities('Demo'))
                    | rejectattr('entity_id', 'in', integration_entities('bambu_lab') + integration_entities('browser_mod'))
                    | selectattr('state' , 'eq' , 'on')
                    | selectattr('attributes.brightness', 'defined')
                    | map(attribute='entity_id')
                    | list
                }}
          - if: "{{ lights | count > 0 }}"
            then:
              - service: light.turn_on
                data:
                  entity_id: "{{ lights }}"
                  color_temp: "{{ temperature }}"
